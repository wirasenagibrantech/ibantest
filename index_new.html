<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Penjualan — GitHub Pages</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables + Buttons (Bootstrap 5 integration) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

  <style>
    body { background:#f8f9fa; padding-top:1.5rem; padding-bottom:2rem; }
    .card { overflow: visible; }
    .controls .form-select { max-width: 180px; display:inline-block; margin-right:8px; }
    .btn-download { margin-left:8px; }
    @media (max-width:576px) {
      .controls { display:block; gap:8px; }
      .controls .form-select { display:block; width:100%; margin-bottom:8px; }
    }
  </style>
</head>
<body>
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">Dashboard Penjualan</h1>
      <small class="text-muted">Static JSON → DataTables, Chart.js, Rekap</small>
    </div>
    <div>
      <a class="btn btn-outline-secondary btn-sm" href="#" id="refreshBtn" title="Refresh data">Refresh</a>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="card mb-4">
    <div class="card-body d-flex flex-wrap align-items-center gap-2 controls">
      <label class="me-2 mb-0">Filter:</label>
      <select id="filterBulan" class="form-select form-select-sm" aria-label="Filter Bulan">
        <option value="">Semua Bulan</option>
      </select>

      <select id="filterTahun" class="form-select form-select-sm" aria-label="Filter Tahun">
        <option value="">Semua Tahun</option>
      </select>

      <button id="btnApply" class="btn btn-primary btn-sm">Terapkan</button>
      <button id="btnReset" class="btn btn-outline-secondary btn-sm">Reset</button>

      <div class="ms-auto d-flex align-items-center">
        <button id="downloadChart" class="btn btn-success btn-sm btn-download">Download Grafik (PNG)</button>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <strong>Data Penjualan</strong>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table id="tabelData" class="table table-striped table-bordered table-sm" style="width:100%">
          <thead class="table-light text-center">
            <tr>
              <th>Tanggal</th>
              <th>Penjualan</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Chart + Rekap -->
  <div class="row">
    <div class="col-lg-8 mb-4">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <strong>Grafik Penjualan (Harian)</strong>
        </div>
        <div class="card-body">
          <canvas id="chartExcel" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4 mb-4">
      <div class="card mb-3">
        <div class="card-header">
          <strong>Rekap Per Bulan</strong>
        </div>
        <ul id="rekapBulan" class="list-group list-group-flush"></ul>
      </div>

      <div class="card">
        <div class="card-header">
          <strong>Rekap Per Minggu</strong>
        </div>
        <ul id="rekapMinggu" class="list-group list-group-flush"></ul>
      </div>
    </div>
  </div>

</div>

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables + Bootstrap 5 -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- Buttons + bootstrap integration -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>

<!-- Export libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<!-- Buttons exporters -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ========== UTILITIES ========== */
const NAMA_BULAN_SHORT = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];

function formatTanggalIndoShort(iso) {
  const d = new Date(iso);
  if (isNaN(d)) return iso;
  return `${d.getDate()} ${NAMA_BULAN_SHORT[d.getMonth()]} ${d.getFullYear()}`;
}

function pad(n){ return String(n).padStart(2,'0'); }

/* Convert Excel serial (if any) -> YYYY-MM-DD:
   Many sources will already have ISO dates; this function tries to detect numeric Excel serials */
function normalizeDate(val){
  if (val === null || val === undefined || val === "") return null;
  if (typeof val === "number") {
    // Excel serial to JS date
    const utc_days = Math.floor(val - 25569);
    const utc_seconds = utc_days * 86400;
    const d = new Date(utc_seconds * 1000);
    return d.toISOString().split("T")[0];
  }
  // try parseable string
  const t = new Date(val);
  if (!isNaN(t)) return t.toISOString().split("T")[0];
  return null;
}

/* Week number (ISO week) */
function getISOWeekNumber(dateObj) {
  const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

/* ========== DATA / RENDER ========== */
let originalData = [];   // array of {date: 'YYYY-MM-DD', value: number}
let filteredData = [];
let dataTableInstance = null;
let chartInstance = null;

async function fetchData(){
  try {
    const res = await fetch('data.json', {cache:'no-store'});
    if (!res.ok) throw new Error(`Gagal memuat data.json (${res.status})`);
    let raw = await res.json();

    // Normalize and map
    const mapped = raw.map(r => {
      // support keys 'date','value' or 'tanggal','jumlah' etc
      const dateRaw = r.date ?? r.tanggal ?? r.tgl ?? r.Tanggal ?? r.Date ?? null;
      const valueRaw = r.value ?? r.value_penjualan ?? r.jumlah ?? r.jml ?? r.value ?? r.Value ?? 0;
      const dateNorm = normalizeDate(dateRaw);
      return dateNorm ? { date: dateNorm, value: Number(valueRaw || 0) } : null;
    }).filter(Boolean);

    // sort asc
    mapped.sort((a,b) => new Date(a.date) - new Date(b.date));
    originalData = mapped;
    filteredData = [...originalData];

    populateFilters();
    renderAll();

  } catch (err) {
    console.error(err);
    alert('Terjadi kesalahan memuat data.json. Cek console untuk detail.');
  }
}

function populateFilters(){
  const tahunSet = new Set();
  const bulanSet = new Set();

  originalData.forEach(i => {
    const d = new Date(i.date);
    tahunSet.add(d.getFullYear());
    bulanSet.add(d.getMonth()+1);
  });

  const selTahun = document.getElementById('filterTahun');
  const selBulan = document.getElementById('filterBulan');

  // reset
  selTahun.innerHTML = '<option value="">Semua Tahun</option>';
  Array.from(tahunSet).sort().forEach(t => {
    selTahun.innerHTML += `<option value="${t}">${t}</option>`;
  });

  selBulan.innerHTML = '<option value="">Semua Bulan</option>';
  Array.from(bulanSet).sort((a,b)=>a-b).forEach(m => {
    selBulan.innerHTML += `<option value="${m}">${NAMA_BULAN_SHORT[m-1]} (${pad(m)})</option>`;
  });
}

function applyFilters(){
  const selTahun = document.getElementById('filterTahun').value;
  const selBulan = document.getElementById('filterBulan').value;

  filteredData = originalData.filter(i => {
    const d = new Date(i.date);
    return (!selTahun || d.getFullYear() == selTahun) &&
           (!selBulan || d.getMonth()+1 == selBulan);
  });

  renderAll();
}

function resetFilters(){
  document.getElementById('filterTahun').value = "";
  document.getElementById('filterBulan').value = "";
  filteredData = [...originalData];
  renderAll();
}

function renderAll(){
  renderTable();
  renderChart();
  renderRekapBulan();
  renderRekapMinggu();
}

/* TABLE */
function renderTable(){
  const tbody = document.querySelector('#tabelData tbody');
  tbody.innerHTML = '';
  filteredData.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="text-center">${formatTanggalIndoShort(r.date)}</td><td class="text-end">${r.value}</td>`;
    tbody.appendChild(tr);
  });

  if (dataTableInstance) {
    dataTableInstance.destroy();
    dataTableInstance = null;
  }

  dataTableInstance = $('#tabelData').DataTable({
    dom: 'Bfrtip',
    buttons: [
      { extend:'excelHtml5', text:'Excel', className:'btn btn-outline-success btn-sm' },
      { extend:'pdfHtml5', text:'PDF', className:'btn btn-outline-danger btn-sm', orientation:'landscape', pageSize:'A4' },
      { extend:'csvHtml5', text:'CSV', className:'btn btn-outline-primary btn-sm' },
      { extend:'copy', text:'Copy', className:'btn btn-outline-secondary btn-sm' },
      { extend:'print', text:'Print', className:'btn btn-outline-dark btn-sm' }
    ],
    paging: true,
    pageLength: 10,
    order: [[0,'asc']],
    language: { emptyTable: "Tidak ada data tersedia" }
  });
}

/* CHART */
function renderChart(){
  const labels = filteredData.map(i => formatTanggalIndoShort(i.date));
  const dataVals = filteredData.map(i => i.value);

  const ctx = document.getElementById('chartExcel').getContext('2d');

  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Penjualan',
        data: dataVals,
        borderColor: 'rgba(37,99,235,1)',
        backgroundColor: 'rgba(37,99,235,0.08)',
        tension: 0.3,
        pointRadius: 3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      },
      plugins: { legend: { display: true } }
    }
  });
}

/* DOWNLOAD CHART PNG */
function downloadChartPNG(){
  if (!chartInstance) { alert('Grafik belum tersedia'); return; }
  const url = chartInstance.toBase64Image();
  const a = document.createElement('a');
  a.href = url;
  a.download = 'grafik-penjualan.png';
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* REKAP PER BULAN */
function renderRekapBulan(){
  const map = {};
  filteredData.forEach(i => {
    const d = new Date(i.date);
    const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
    map[key] = (map[key] || 0) + i.value;
  });
  const keys = Object.keys(map).sort();
  const ul = document.getElementById('rekapBulan');
  ul.innerHTML = '';
  if (keys.length === 0) {
    ul.innerHTML = `<li class="list-group-item">Tidak ada data</li>`;
    return;
  }
  keys.forEach(k => {
    const [y,m] = k.split('-');
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<span>${NAMA_BULAN_SHORT[Number(m)-1]} ${y}</span><strong>${map[k]}</strong>`;
    ul.appendChild(li);
  });
}

/* REKAP PER MINGGU */
function renderRekapMinggu(){
  const map = {};
  filteredData.forEach(i => {
    const d = new Date(i.date);
    const week = getISOWeekNumber(d);
    const key = `${d.getFullYear()}-W${pad(week)}`;
    map[key] = (map[key] || 0) + i.value;
  });
  const keys = Object.keys(map).sort();
  const ul = document.getElementById('rekapMinggu');
  ul.innerHTML = '';
  if (keys.length === 0) {
    ul.innerHTML = `<li class="list-group-item">Tidak ada data</li>`;
    return;
  }
  keys.forEach(k => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<span>${k}</span><strong>${map[k]}</strong>`;
    ul.appendChild(li);
  });
}

/* EVENTS */
document.getElementById('btnApply').addEventListener('click', applyFilters);
document.getElementById('btnReset').addEventListener('click', resetFilters);
document.getElementById('downloadChart').addEventListener('click', downloadChartPNG);
document.getElementById('refreshBtn').addEventListener('click', (e) => { e.preventDefault(); fetchData(); });

/* INIT */
fetchData();
</script>
</body>
</html>
